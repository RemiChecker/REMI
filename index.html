<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presse Remi – Abgleich</title>
  <meta name="theme-color" content="#0a84ff">

  <style>
    :root { --blue:#0a84ff; --muted:#666; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:1rem auto;max-width:1150px;padding:0 1rem}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:1.45rem;margin:.5rem 0}
    h2{margin:.7rem 0 .35rem}
    .muted{color:var(--muted);font-size:.95rem}
    .banner{margin:.75rem 0;padding:.6rem .8rem;border:1px solid #dbe5ff;background:#f4f7ff;border-radius:.6rem;color:#1a3daa}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:1rem;background:#eef3ff;color:#0a84ff;font-size:.85rem}
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .tab{padding:.45rem .7rem;border:1px solid #d0d0d0;border-radius:.6rem;cursor:pointer}
    .tab.active{background:#0a84ff;color:#fff;border-color:#0a84ff}
    button{padding:.55rem .85rem;border-radius:.6rem;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
    button.primary{background:#0a84ff;color:#fff;border-color:#0a84ff}
    textarea{width:100%;min-height:160px;border:1px solid #d0d0d0;border-radius:.6rem;padding:.6rem;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    input[type="text"],input[type="date"],select{padding:.5rem .65rem;border:1px solid #d0d0d0;border-radius:.6rem}
    .list{margin-top:.6rem}
    .card{border:1px solid #e8e8e8;border-radius:.8rem;padding:.75rem .9rem;margin:.5rem 0;background:#fff}
    details summary{list-style:none;cursor:pointer}
    details summary::-webkit-details-marker{display:none}
    .row{display:grid;grid-template-columns:120px 120px 1fr 120px;gap:.6rem;align-items:center}
    .chip{display:inline-block;border:1px solid #e0e0e0;border-radius:999px;padding:.15rem .5rem;font-size:.85rem;margin:.1rem .25rem 0 0}
    .toast{position:fixed;top:12px;right:12px;z-index:9999;background:#0a84ff;color:#fff;padding:.55rem .7rem;border-radius:.6rem;display:none}
    .totals{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;padding:.5rem .6rem;border:1px solid #eee;border-radius:.6rem;background:#fbfbfb;margin:.5rem 0}
    .totals .badge{padding:.2rem .5rem;border:1px solid #e0e0e0;border-radius:999px}
    .drop{border:2px dashed #c9d1e6;border-radius:.6rem;padding:10px;background:#f8faff}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin:.6rem 0}
  </style>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval-iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="toast" class="toast"></div>

  <header>
    <div>
      <h1>Presse Remi – Abgleich</h1>
      <div class="muted">Lokale Speicherung. Offline nutzbar.</div>
      <div class="banner">ℹ️ Rechnungen & Remissionen werden nur <u>3 Monate</u> gespeichert. Ältere Einträge werden automatisch gelöscht.</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center;">
      <button id="forceUpdate">Update erzwingen</button>
      <span class="pill">v10 – 30.09.2025</span>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="main">Übersicht</div>
    <div class="tab" data-tab="settings">Einstellungen</div>
    <div class="tab" data-tab="stats">Statistik</div>
  </div>

  <!-- Übersicht -->
  <section data-view="main">
    <h2>1) Daten eingeben</h2>
    <p class="muted">Option A: JSON hier einfügen und speichern.<br>Option B: Datei importieren (PDF, EML, JSON).<br>Option C: Direkt über Gmail abrufen.</p>
    <textarea id="inputArea"></textarea>
    <div class="actions">
      <button id="saveBtn" class="primary">Speichern</button>
      <button id="loadBtn">Laden</button>
      <button id="clearBtn">Löschen</button>
      <button id="exportCsv">CSV</button>
      <button id="exportPdf">PDF</button>
      <button id="exportJson">JSON</button>
      <label>
        <input id="importFile" type="file" accept=".json,.eml,application/pdf" style="display:none">
        <button id="importBtn">Import Datei</button>
      </label>
      <span style="flex:1"></span>
      <button id="gmailConnect">Gmail verbinden</button>
      <button id="gmailFetch" disabled>E-Mails abrufen</button>
    </div>

    <div class="drop" id="dropZone">Oder Datei per Drag&Drop hier ablegen</div>

    <h2>2) Filter</h2>
    <div class="actions">
      <select id="kdnrSelect"><option value="">Alle Kunden</option></select>
      <input id="searchInput" placeholder="Suchen…">
      <label>Von <input id="dateFrom" type="date"></label>
      <label>Bis <input id="dateTo" type="date"></label>
      <button id="toggleMissing">Nur fehlende anzeigen</button>
      <button id="clearSearch">Leeren</button>
    </div>

    <div id="totals" class="totals" hidden>
      <span class="badge" id="badgeCount">0 Pakete</span>
      <span class="badge" id="badgeMissing">0 fehlend</span>
      <span class="badge" id="badgeSum">Summe: –</span>
    </div>

    <div id="overview" class="list"></div>
  </section>

  <!-- Einstellungen -->
  <section data-view="settings" style="display:none;">
    <h2>Einstellungen</h2>
    <div style="display:grid;grid-template-columns:180px 1fr;gap:.5rem .75rem;max-width:720px;">
      <div>Erlaubter Absender 1</div><input id="allowed1" placeholder="z.B. remi@qtrado.de">
      <div>Erlaubter Absender 2</div><input id="allowed2">
      <div>Erlaubter Absender 3</div><input id="allowed3">
      <div>Suchwörter</div><input id="keywords" placeholder="z.B. Remission, Rechnung, Qtrado">
      <div></div><button id="settingsSave" class="primary">Speichern</button>
    </div>
  </section>

  <!-- Statistik -->
  <section data-view="stats" style="display:none;">
    <h2>Statistik</h2>
    <div id="statsBox" class="card"></div>
  </section>

  <script>
/* ===== Google Client-ID (richtig eingetragen) ===== */
const GOOGLE_CLIENT_ID = "836994805779-78af1p2hpubkidbklko086s93j165lv5.apps.googleusercontent.com";
let gisClient=null, accessToken=null;

document.getElementById('gmailConnect').addEventListener('click', () => {
  if (!window.google || !google.accounts || !google.accounts.oauth2) {
    alert("Google API nicht geladen – bitte neu laden");
    return;
  }
  gisClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/gmail.readonly',
    prompt: 'consent',
    callback: (resp) => {
      if (resp && resp.access_token) {
        accessToken = resp.access_token;
        document.getElementById('gmailFetch').disabled = false;
        alert("Gmail verbunden ✅");
      } else {
        alert("Login abgebrochen");
      }
    }
  });
  gisClient.requestAccessToken();
});

document.getElementById('gmailFetch').addEventListener('click', async () => {
  if (!accessToken) { alert("Bitte erst Gmail verbinden"); return; }
  alert("Abruf gestartet (Dummy-Test) ✅");
});
  </script>
</body>
</html>
