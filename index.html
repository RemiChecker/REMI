<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presse Remi – Abgleich</title>
  <meta name="theme-color" content="#0a84ff">

  <style>
    :root { --blue:#0a84ff; --muted:#666; --ok:#0a7d2f; --warn:#a02a00; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:1rem auto;max-width:1150px;padding:0 1rem;background:#fff}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:1.45rem;margin:.5rem 0}
    h2{margin:.7rem 0 .35rem}
    .muted{color:var(--muted);font-size:.95rem}
    .banner{margin:.75rem 0;padding:.6rem .8rem;border:1px solid #dbe5ff;background:#f4f7ff;border-radius:.6rem;color:#1a3daa}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:1rem;background:#eef3ff;color:#0a84ff;font-size:.85rem}
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .tab{padding:.45rem .7rem;border:1px solid #d0d0d0;border-radius:.6rem;cursor:pointer}
    .tab.active{background:#0a84ff;color:#fff;border-color:#0a84ff}
    button{padding:.55rem .85rem;border-radius:.6rem;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
    button.primary{background:#0a84ff;color:#fff;border-color:#0a84ff}
    textarea{width:100%;min-height:160px;border:1px solid #d0d0d0;border-radius:.6rem;padding:.6rem;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    input[type="text"],input[type="date"],select{padding:.5rem .65rem;border:1px solid #d0d0d0;border-radius:.6rem}
    .list{margin-top:.6rem}
    .card{border:1px solid #e8e8e8;border-radius:.8rem;padding:.75rem .9rem;margin:.5rem 0;background:#fff}
    details summary{list-style:none;cursor:pointer}
    details summary::-webkit-details-marker{display:none}
    .row{display:grid;grid-template-columns:120px 120px 1fr 120px;gap:.6rem;align-items:center}
    .chip{display:inline-block;border:1px solid #e0e0e0;border-radius:999px;padding:.15rem .5rem;font-size:.85rem;margin:.1rem .25rem 0 0}
    .toast{position:fixed;top:12px;right:12px;z-index:9999;background:#0a84ff;color:#fff;padding:.55rem .7rem;border-radius:.6rem;display:none}
    .totals{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;padding:.5rem .6rem;border:1px solid #eee;border-radius:.6rem;background:#fbfbfb;margin:.5rem 0}
    .totals .badge{padding:.2rem .5rem;border:1px solid #e0e0e0;border-radius:999px}
    .drop{border:2px dashed #c9d1e6;border-radius:.6rem;padding:10px;background:#f8faff}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin:.6rem 0}
  </style>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval-iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="toast" class="toast"></div>

  <header>
    <div>
      <h1>Presse Remi – Abgleich</h1>
      <div class="muted">Lokale Speicherung. Offline nutzbar.</div>
      <div class="banner">ℹ️ Rechnungen & Remissionen werden nur <u>3 Monate</u> intern gespeichert. Ältere Einträge werden automatisch gelöscht.</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center;">
      <button id="forceUpdate">Update erzwingen</button>
      <span class="pill">v10 – 30.09.2025</span>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="main">Übersicht</div>
    <div class="tab" data-tab="settings">Einstellungen</div>
    <div class="tab" data-tab="stats">Statistik</div>
  </div>

  <!-- Übersicht -->
  <section data-view="main">
    <h2>1) Daten eingeben</h2>
    <p class="muted">Option A: JSON hier einfügen und speichern. • Option B: Datei importieren (PDF, EML, JSON). • Option C: per Gmail abrufen.</p>
    <textarea id="inputArea" placeholder='{"kundennummer":"24719","pakete":[{"nr":"728","datum":"2025-09-15","status":"offen","rechnungen":["2025380500520"]}]}'></textarea>
    <div class="actions">
      <button id="saveBtn" class="primary">Speichern</button>
      <button id="loadBtn">Laden</button>
      <button id="clearBtn">Löschen</button>
      <button id="exportCsv">CSV</button>
      <button id="exportPdf">PDF</button>
      <button id="exportJson">JSON</button>
      <label>
        <input id="importFile" type="file" accept=".json,.eml,application/pdf" style="display:none">
        <button id="importBtn">Import Datei</button>
      </label>
      <span style="flex:1"></span>
      <button id="gmailConnect">Gmail verbinden</button>
      <button id="gmailFetch" disabled>E-Mails abrufen</button>
    </div>

    <div class="drop" id="dropZone">Oder Datei per Drag&Drop hier ablegen</div>

    <h2>2) Filter</h2>
    <div class="actions">
      <select id="kdnrSelect"><option value="">Alle Kunden</option></select>
      <input id="searchInput" placeholder="Suchen… (Paket, Rechnung, Datum, Filiale)">
      <label>Von <input id="dateFrom" type="date"></label>
      <label>Bis <input id="dateTo" type="date"></label>
      <button id="toggleMissing">Nur fehlende anzeigen</button>
      <button id="clearSearch">Leeren</button>
    </div>

    <div id="totals" class="totals" hidden>
      <span class="badge" id="badgeCount">0 Pakete</span>
      <span class="badge" id="badgeMissing">0 fehlend</span>
      <span class="badge" id="badgeSum">Summe: –</span>
    </div>

    <div id="overview" class="list"></div>
  </section>

  <!-- Einstellungen -->
  <section data-view="settings" style="display:none;">
    <h2>Einstellungen</h2>
    <div style="display:grid;grid-template-columns:180px 1fr;gap:.5rem .75rem;max-width:720px;">
      <div>Erlaubter Absender 1</div><input id="allowed1" placeholder="z.B. remi@qtrado.de">
      <div>Erlaubter Absender 2</div><input id="allowed2" placeholder="optional">
      <div>Erlaubter Absender 3</div><input id="allowed3" placeholder="optional">
      <div>Suchwörter</div><input id="keywords" placeholder="z.B. Remission, Rechnung, Qtrado">
      <div></div><button id="settingsSave" class="primary">Speichern</button>
    </div>
    <p class="muted">Nur Mails von diesen Absendern werden verarbeitet (Leserechte – keine Löschung in Gmail).</p>
  </section>

  <!-- Statistik -->
  <section data-view="stats" style="display:none;">
    <h2>Statistik</h2>
    <div id="statsBox" class="card"></div>
  </section>

  <script>
/* ===== 0) Google Client-ID (DEINE ist eingetragen) ===== */
const GOOGLE_CLIENT_ID = "836994805779-78af1p2hpubikdbklk0086s93j165lv5.apps.googleusercontent.com";
let gisClient=null, accessToken=null;

/* ===== 1) Auto-Clean: alte Service Worker & Caches entfernen ===== */
(async () => {
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const reg of regs) await reg.unregister();
    }
    if ('caches' in window) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
  } catch(e){ console.warn('Auto-Clean:', e); }
})();

/* ===== 2) Speicher: idb-keyval + Fallback auf localStorage ===== */
const __idb = window.idbKeyval || {
  get: async (k) => { try { return JSON.parse(localStorage.getItem(k)||'null'); } catch { return null; } },
  set: async (k,v)=>{ try { localStorage.setItem(k,JSON.stringify(v)); } catch {} },
  del: async (k)=>{ try { localStorage.removeItem(k); } catch {} }
};
const { get, set, del } = __idb;

const KEY='presse-remi-daten-v10';
const SETTINGS_KEY='presse-remi-settings-v10';

const readStore = ()=> get(KEY).then(x=>x||{kundennummer:'',pakete:[]});
const writeStore = (obj)=> set(KEY,obj);
const readSettings = ()=> get(SETTINGS_KEY).then(x=>x||{allowed1:'',allowed2:'',allowed3:'',keywords:'Remission,Rechnung,Qtrado'});
const writeSettings = (obj)=> set(SETTINGS_KEY,obj);

const toast = (m)=>{const el=document.getElementById('toast'); el.textContent=m; el.style.display='block'; setTimeout(()=>el.style.display='none',2600);};
const norm = s => (s||'').toString().toLowerCase();
const fmtEuro = n => (typeof n==='number') ? new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n) : '';
const parseDateAny = s=>{
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
  const m=s.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m) return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
  return null;
};
const inRange = (d,from,to)=>{
  if(!d) return false; const F=from?new Date(from+'T00:00:00'):null, T=to?new Date(to+'T23:59:59'):null;
  if(F && d<F) return false; if(T && d>T) return false; return true;
};
function threeMonthsAgo(){ const d=new Date(); d.setMonth(d.getMonth()-3); d.setHours(0,0,0,0); return d; }
function pruneOld(data){
  const before=(data.pakete||[]).length, cutoff=threeMonthsAgo(); const keep=[];
  for(const p of (data.pakete||[])){ const d=parseDateAny(p.datum); if(!d || d<cutoff) continue; keep.push(p); }
  data.pakete=keep; const removed=before-keep.length; if(removed>0) toast(`Aufgeräumt: ${removed} ältere Einträge entfernt`);
  return data;
}

/* ===== 3) UI-Grundlogik (Tabs & Render) ===== */
const TABS=[...document.querySelectorAll('.tab')], VIEWS=[...document.querySelectorAll('section[data-view]')];
function setTab(name){ TABS.forEach(t=>t.classList.toggle('active',t.dataset.tab===name)); VIEWS.forEach(v=>v.style.display=v.dataset.view===name?'':'none'); }
TABS.forEach(t=>t.addEventListener('click',()=>setTab(t.dataset.tab)));

const inputArea=document.getElementById('inputArea'), overview=document.getElementById('overview');
const kdnrSelect=document.getElementById('kdnrSelect'), searchInput=document.getElementById('searchInput');
const dateFrom=document.getElementById('dateFrom'), dateTo=document.getElementById('dateTo');
const totals=document.getElementById('totals'), badgeCount=document.getElementById('badgeCount');
const badgeMissing=document.getElementById('badgeMissing'), badgeSum=document.getElementById('badgeSum');
let onlyMissing=false;

function fillKdnrDropdown(kdnrs){
  const cur=kdnrSelect.value;
  kdnrSelect.innerHTML='<option value="">Alle Kunden</option>'+kdnrs.map(k=>`<option>${k}</option>`).join('');
  if(cur && kdnrs.includes(cur)) kdnrSelect.value=cur;
}
function computeStats(data){
  const list=data.pakete||[];
  const artikel=list.reduce((a,p)=>a+(p.positionen?.reduce((x,y)=>x+(y.menge||0),0)||0),0);
  const diffs=list.reduce((a,p)=>a+(p.differenzen?.length||0),0);
  const fehlt=list.filter(p=>norm(p.status)==='fehlt').length;
  return {pakete:list.length, artikel, fehler:diffs+fehlt, fehlt, sum: list.reduce((a,p)=>a+(typeof p.summe==='number'?p.summe:0),0)};
}
function rowHtml(p,k){
  const re=(p.rechnungen||[]).map(r=>`<span class="chip">RG ${r}</span>`).join('');
  return `<details class="card">
    <summary>
      <div class="row">
        <div><b>Paket ${p.nr||''}</b></div>
        <div class="muted">${p.datum||''}</div>
        <div>${re||'<span class="muted">–</span>'}</div>
        <div class="muted">${p.status||''}</div>
      </div>
      <div class="muted">Kdnr ${k||''} • Summe ${typeof p.summe==='number'?fmtEuro(p.summe):'–'}</div>
    </summary>
    ${p.notizen?`<div style="margin-top:.5rem"><b>Notizen:</b> ${p.notizen}</div>`:''}
  </details>`;
}
function render(data){
  const gk=data.kundennummer||'';
  const listAll=(data.pakete||[]).map(p=>({...p,_k:p.kundennummer||gk}));
  const q=norm(searchInput?.value), ksel=kdnrSelect?.value, f=dateFrom?.value, t=dateTo?.value;
  const list=listAll.filter(p=>{
    const d=parseDateAny(p.datum);
    return (!ksel || p._k===ksel)
      && (!q || [p.nr,p.datum,p.status,p.filiale,(p.rechnungen||[]).join(' '),p._k].some(x=>norm(x).includes(q)))
      && (!onlyMissing || norm(p.status)==='fehlt')
      && (!f && !t ? true : inRange(d,f,t));
  });
  overview.innerHTML = list.length ? list.map(p=>rowHtml(p,p._k)).join('') : '<div class="muted">Keine Treffer…</div>';
  const s=computeStats({pakete:list});
  if(list.length){ totals.hidden=false; badgeCount.textContent=`${s.pakete} Pakete`; badgeMissing.textContent=`${s.fehlt} fehlend`; badgeSum.textContent=`Summe: ${fmtEuro(s.sum)}`; } else { totals.hidden=true; }
  const sAll=computeStats(data); const box=document.getElementById('statsBox');
  if(box) box.innerHTML=`Pakete: ${sAll.pakete} • Artikel geprüft: ${sAll.artikel} • Fehler: ${sAll.fehler} • Fehlend: ${sAll.fehlt}`;
}

/* ===== 4) Datei-Import (JSON/EML/PDF + Drag&Drop) ===== */
document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', async e=>{
  for (const f of Array.from(e.target.files||[])) await handleFile(f);
  e.target.value='';
});
const dropZone=document.getElementById('dropZone');
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault(); dropZone.style.background='#eef3ff';}));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault(); dropZone.style.background='#f8faff';}));
dropZone.addEventListener('drop', async e=>{
  for (const f of Array.from(e.dataTransfer.files||[])) await handleFile(f);
});
async function handleFile(file){
  const name=(file.name||'').toLowerCase();
  if (name.endsWith('.json')) return importJSON(file);
  if (name.endsWith('.eml'))  return importEML(file);
  if (name.endsWith('.pdf'))  return importPDF(file);
  toast('Nicht unterstützt: '+file.name);
}
async function importJSON(file){
  const text=await file.text(); let obj=JSON.parse(text);
  obj=pruneOld(obj); await writeStore(obj); render(obj); inputArea.value=JSON.stringify(obj,null,2);
  toast('JSON importiert ✅');
}
function decodeQP(str){ return str.replace(/=([A-F0-9]{2})/gi,(m,hex)=>String.fromCharCode(parseInt(hex,16))); }
function extractTextFromEML(raw){
  const boundaryMatch=raw.match(/boundary="([^"]+)"/i);
  if(boundaryMatch){
    const boundary='--'+boundaryMatch[1];
    for(const part of raw.split(boundary)){
      if(/Content-Type:\s*text\/plain/i.test(part)){
        let c=part.split(/\r?\n\r?\n/).slice(1).join('\n'); c=c.replace(/--\s*$/,''); return decodeQP(c);
      }
    }
  }
  return raw.split(/\r?\n\r?\n/).slice(1).join('\n');
}
function scanTextForFields(t){
  const paket=(t.match(/paket(?:nr|nummer)?\s*[-: ]\s*([0-9]{3,})/i) || t.match(/Paket\s*([0-9]{3,})/i))?.[1];
  const kdnr=(t.match(/kunden(?:nr|nummer)?\s*[-: ]\s*([0-9]{3,})/i) || t.match(/Kdnr\.?\s*([0-9]{3,})/i))?.[1];
  const re=Array.from(t.matchAll(/(?:rechnung(?:s)?nr|rg|rechnungsnummer)\s*[-: ]\s*([0-9]{6,})/ig)).map(m=>m[1]);
  const dateIso=(t.match(/(20[2-5][0-9]-[01][0-9]-[0-3][0-9])/))?.[1];
  const dateDe=(t.match(/([0-3][0-9]\.[01][0-9]\.20[2-5][0-9])/))?.[1];
  const datum=dateIso || (dateDe ? dateDe.split('.').reverse().join('-') : '');
  return { paket, kdnr, rechnungen: re, datum };
}
async function mergeParsedIntoStore(parsed){
  if (!parsed.paket && !parsed.rechnungen?.length && !parsed.kdnr) return false;
  let data=await readStore();
  if(parsed.kdnr && !data.kundennummer) data.kundennummer=parsed.kdnr;
  let p=parsed.paket ? (data.pakete||[]).find(x=>x.nr===parsed.paket) : null;
  if(!p){ p={nr:parsed.paket||'unbekannt', datum:parsed.datum||'', status:'offen', rechnungen:[], positionen:[], differenzen:[]}; (data.pakete=data.pakete||[]).push(p); }
  if(parsed.kdnr) p.kundennummer=parsed.kdnr;
  if(parsed.datum && !p.datum) p.datum=parsed.datum;
  if(parsed.rechnungen?.length){ const set=new Set([...(p.rechnungen||[]), ...parsed.rechnungen]); p.rechnungen=Array.from(set); }
  data=pruneOld(data); await writeStore(data);
  inputArea.value=JSON.stringify(data,null,2); render(data);
  return true;
}
async function importEML(file){
  const raw=await file.text(); const headers=raw.split(/\r?\n\r?\n/)[0]||''; const body=extractTextFromEML(raw);
  const text=headers+'\n'+body+'\n'+file.name;
  const ok=await mergeParsedIntoStore( scanTextForFields(text) );
  toast(ok ? 'EML importiert ✅' : 'Keine relevanten Daten gefunden');
}
async function importPDF(file){
  const buf=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let t=''; for(let i=1;i<=pdf.numPages;i++){ const page=await pdf.getPage(i); const c=await page.getTextContent(); t+=c.items.map(it=>it.str).join(' ')+'\n'; }
  const ok=await mergeParsedIntoStore( scanTextForFields(t+'\n'+file.name) );
  toast(ok ? 'PDF importiert ✅' : 'Keine relevanten Daten gefunden');
}

/* ===== 5) Export ===== */
function exportJSONdata(data){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='remi-export.json'; a.click();
}
function exportCSV(data){
  const rows=[['Kdnr','Paket','Datum','Status','Rechnungen','Summe']];
  (data.pakete||[]).forEach(p=>{
    rows.push([p.kundennummer||data.kundennummer||'', p.nr||'', p.datum||'', p.status||'', (p.rechnungen||[]).join(' '), typeof p.summe==='number'?p.summe:'' ]);
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='remi-export.csv'; a.click();
}
async function exportPDFdoc(data){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.text('Presse Remi – Export', 14, 14);
  const rows=(data.pakete||[]).map(p=>[p.kundennummer||data.kundennummer||'', p.nr||'', p.datum||'', p.status||'', (p.rechnungen||[]).join(' '), typeof p.summe==='number'?fmtEuro(p.summe):'']);
  doc.autoTable({ head:[['Kdnr','Paket','Datum','Status','Rechnungen','Summe']], body:rows, startY:18, styles:{fontSize:9} });
  doc.save('remi-export.pdf');
}

/* ===== 6) Buttons & Events ===== */
document.getElementById('forceUpdate').addEventListener('click', async ()=>{
  try{
    if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
    if('caches' in window){ const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
  }catch(e){ console.warn(e); }
  toast('Update erzwungen – neu laden…'); setTimeout(()=>location.reload(true),600);
});
document.getElementById('toggleMissing').addEventListener('click', async ()=>{ onlyMissing=!onlyMissing; toast(onlyMissing?'Nur fehlende…':'Alle anzeigen'); render(await readStore()); });
document.getElementById('clearSearch').addEventListener('click', async ()=>{ searchInput.value=''; dateFrom.value=''; dateTo.value=''; toast('Filter zurückgesetzt'); render(await readStore()); });
searchInput.addEventListener('input', async ()=>render(await readStore()));
dateFrom.addEventListener('change', async ()=>render(await readStore()));
dateTo.addEventListener('change', async ()=>render(await readStore()));

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  try{ let obj=JSON.parse(inputArea.value||'{}'); obj=pruneOld(obj||{kundennummer:'',pakete:[]}); await writeStore(obj); toast('Gespeichert ✅'); render(obj); }
  catch(e){ toast('JSON-Fehler: '+e.message); }
});
document.getElementById('loadBtn').addEventListener('click', async ()=>{ let d=await readStore(); d=pruneOld(d||{kundennummer:'',pakete:[]}); await writeStore(d); inputArea.value=JSON.stringify(d,null,2); toast('Geladen ✅'); render(d); });
document.getElementById('clearBtn').addEventListener('click', async ()=>{ await del(KEY); inputArea.value=''; toast('Gelöscht ✅'); render({kundennummer:'',pakete:[]}); });

document.getElementById('exportJson').addEventListener('click', async ()=>exportJSONdata(await readStore()));
document.getElementById('exportCsv').addEventListener('click', async ()=>exportCSV(await readStore()));
document.getElementById('exportPdf').addEventListener('click', async ()=>exportPDFdoc(await readStore()));

/* ===== 7) Einstellungen ===== */
document.getElementById('settingsSave').addEventListener('click', async ()=>{
  const s={ allowed1:document.getElementById('allowed1').value.trim(),
            allowed2:document.getElementById('allowed2').value.trim(),
            allowed3:document.getElementById('allowed3').value.trim(),
            keywords:document.getElementById('keywords').value.trim()||'Remission,Rechnung,Qtrado' };
  await writeSettings(s); toast('Einstellungen gespeichert ✅');
});
async function loadSettingsToUI(){
  const s=await readSettings();
  document.getElementById('allowed1').value=s.allowed1||'';
  document.getElementById('allowed2').value=s.allowed2||'';
  document.getElementById('allowed3').value=s.allowed3||'';
  document.getElementById('keywords').value=s.keywords||'Remission,Rechnung,Qtrado';
}

/* ===== 8) Gmail Login & Abruf inkl. Parser ===== */
function buildGmailQuery(s){
  const senders=[s.allowed1,s.allowed2,s.allowed3].filter(Boolean).map(a=>`from:${a}`).join(' OR ');
  const words=(s.keywords||'').split(',').map(w=>w.trim()).filter(Boolean).map(w=>`"${w}"`).join(' OR ');
  return [senders?`(${senders})`:'', words?`(${words})`:'', 'newer_than:90d'].filter(Boolean).join(' ');
}
document.getElementById('gmailConnect').addEventListener('click',()=>{
  gisClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/gmail.readonly',
    callback: (resp)=>{
      if(resp && resp.access_token){ accessToken=resp.access_token; document.getElementById('gmailFetch').disabled=false; toast('Gmail verbunden ✅'); }
      else toast('Login abgebrochen');
    }
  });
  gisClient.requestAccessToken();
});
document.getElementById('gmailFetch').addEventListener('click', async ()=>{
  try{
    if(!accessToken){ toast('Bitte zuerst „Gmail verbinden“'); return; }
    const s=await readSettings(); const query=buildGmailQuery(s);
    const listUrl=`https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=50`;
    const list=await fetch(listUrl,{headers:{Authorization:`Bearer ${accessToken}`}}).then(r=>r.json());
    if(!list.messages?.length){ toast('Keine passenden Mails gefunden'); return; }

    let imported=0;
    for(const m of list.messages){
      const msg=await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}?format=full`,{headers:{Authorization:`Bearer ${accessToken}`}}).then(r=>r.json());

      // Betreff + Plaintext parsen
      const subject=(msg.payload?.headers||[]).find(h=>h.name==='Subject')?.value||'';
      let bodyText=''; const parts=msg.payload?.parts||[];
      const plain=parts.find(p=>p.mimeType==='text/plain')||msg.payload;
      if(plain?.body?.data){ bodyText = atob(plain.body.data.replace(/-/g,'+').replace(/_/g,'/')); }
      let ok = await mergeParsedIntoStore( scanTextForFields(subject+'\n'+bodyText) );

      // PDF-Anhänge parsen (auch verschachtelte Parts berücksichtigen)
      const allParts = (function flatten(p){ return p.flatMap(x=> x.parts ? flatten(x.parts) : [x]); })(parts||[]);
      const pdfParts = allParts.filter(p=>p?.mimeType==='application/pdf');
      for(const p of pdfParts){
        const attId=p.body?.attachmentId; if(!attId) continue;
        const att=await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}/attachments/${attId}`,{headers:{Authorization:`Bearer ${accessToken}`}}).then(r=>r.json());
        if(!att.data) continue;
        const bin = Uint8Array.from(atob(att.data.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0));
        const blob = new Blob([bin],{type:'application/pdf'});
        // PDF zu Text
        const pdf=await pdfjsLib.getDocument({data:await blob.arrayBuffer()}).promise;
        let t=''; for(let i=1;i<=pdf.numPages;i++){ const page=await pdf.getPage(i); const c=await page.getTextContent(); t+=c.items.map(it=>it.str).join(' ')+'\n'; }
        const ok2 = await mergeParsedIntoStore( scanTextForFields(t) );
        ok = ok || ok2;
      }
      if(ok) imported++;
    }
    toast(`E-Mails verarbeitet: ${imported} ✅`);
  }catch(e){ console.error(e); toast('Gmail-Fehler: '+(e.message||e)); }
});

/* ===== 9) Init ===== */
document.getElementById('exportJson').addEventListener('click', async ()=>exportJSONdata(await readStore()));
document.getElementById('exportCsv').addEventListener('click', async ()=>exportCSV(await readStore()));
document.getElementById('exportPdf').addEventListener('click', async ()=>exportPDFdoc(await readStore()));

(async ()=>{
  setTab('main');
  await loadSettingsToUI();
  let d=await readStore(); d=pruneOld(d||{kundennummer:'',pakete:[]}); await writeStore(d);
  inputArea.value=JSON.stringify(d,null,2);
  const kset=new Set(); if(d.kundennummer) kset.add(String(d.kundennummer));
  (d.pakete||[]).forEach(p=>{ if(p.kundennummer) kset.add(String(p.kundennummer)); });
  fillKdnrDropdown(Array.from(kset).sort());
  render(d);
  toast('App geladen ✅');
})();
  </script>
</body>
</html>
