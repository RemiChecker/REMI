<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presse Remi ‚Äì Abgleich</title>
  <meta name="theme-color" content="#0a84ff">

  <style>
    body{font-family:sans-serif;margin:1rem auto;max-width:900px;padding:0 1rem}
    h1{font-size:1.4rem}
    .actions{margin:1rem 0;display:flex;gap:.5rem;flex-wrap:wrap}
    textarea{width:100%;min-height:200px}
    button{padding:.5rem .8rem;border:1px solid #ccc;border-radius:.5rem;cursor:pointer}
    button.primary{background:#0a84ff;color:#fff;border-color:#0a84ff}
  </style>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval-iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";</script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Presse Remi ‚Äì Abgleich</h1>
  <p>Rechnungen & Remissionen werden nur 3 Monate gespeichert (√§ltere werden automatisch gel√∂scht).</p>

  <div class="actions">
    <button id="forceUpdate">Update erzwingen</button>
    <button id="gmailConnect" class="primary">Gmail verbinden</button>
    <button id="gmailFetch" disabled>E-Mails abrufen (nur Qtrado)</button>
  </div>

  <textarea id="inputArea" placeholder="Hier erscheinen die Daten‚Ä¶"></textarea>

  <script>
/* === Google Client-ID (deine korrekte) === */
const GOOGLE_CLIENT_ID = "836994805779-78af1p2hpubkidbklko086s93j165lv5.apps.googleusercontent.com";
let gisClient=null, accessToken=null;

/* === Speicher (Fallback auf localStorage) === */
const __idb = window.idbKeyval || {
  get: async (k) => JSON.parse(localStorage.getItem(k)||'null'),
  set: async (k,v)=> localStorage.setItem(k,JSON.stringify(v)),
};
const KEY='presse-remi-daten-v10';
async function readStore(){return await __idb.get(KEY)||{kundennummer:'',pakete:[]};}
async function writeStore(d){await __idb.set(KEY,d);}

/* === Hilfsfunktionen (einfach) === */
function scanTextForFields(t){
  if(!t) return {};
  const paket=(t.match(/(?:paket(?:nr|nummer)?|paket)\s*[-: ]\s*([0-9]{3,})/i) || t.match(/\bPaket\s*([0-9]{3,})\b/i))?.[1];
  const kdnr=(t.match(/kunden(?:nr|nummer)?\s*[-: ]\s*([0-9]{3,})/i) || t.match(/\bKdnr\.?\s*([0-9]{3,})\b/i))?.[1];
  const re=Array.from(t.matchAll(/(?:rechnung(?:s)?nr|rechnungsnummer|rg|rechnung)\s*[-: ]?\s*([0-9]{6,})/ig)).map(m=>m[1]);
  const iso=(t.match(/(20[2-5][0-9]-[01][0-9]-[0-3][0-9])/))?.[1];
  const de=(t.match(/([0-3][0-9]\.[01][0-9]\.20[2-5][0-9])/))?.[1];
  const datum=iso || (de ? de.split('.').reverse().join('-') : '');
  return {paket,kdnr,rechnungen:re,datum};
}
async function mergeParsedIntoStore(parsed){
  if(!parsed.paket && !parsed.kdnr && !parsed.rechnungen?.length) return false;
  let data=await readStore();
  if(parsed.kdnr && !data.kundennummer) data.kundennummer=parsed.kdnr;
  let p=(parsed.paket?data.pakete.find(x=>x.nr===parsed.paket):null);
  if(!p){p={nr:parsed.paket||'unbekannt',datum:parsed.datum||'',status:'offen',rechnungen:[]};data.pakete.push(p);}
  if(parsed.kdnr) p.kundennummer=parsed.kdnr;
  if(parsed.datum && !p.datum) p.datum=parsed.datum;
  if(parsed.rechnungen?.length){ const set=new Set([...(p.rechnungen||[]),...parsed.rechnungen]); p.rechnungen=[...set]; }
  await writeStore(data);
  document.getElementById('inputArea').value=JSON.stringify(data,null,2);
  return true;
}

/* === Update erzwingen === */
document.getElementById('forceUpdate').addEventListener('click', async ()=>{
  try{
    if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
    if('caches' in window){ const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
  }catch(e){}
  alert('Update erzwungen ‚Äì Seite wird neu geladen'); location.reload(true);
});

/* === Gmail Login === */
document.getElementById('gmailConnect').addEventListener('click', () => {
  if (!window.google || !google.accounts || !google.accounts.oauth2) {
    alert("Google API nicht geladen ‚Äì bitte neu laden");
    return;
  }
  gisClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/gmail.readonly',
    prompt: 'consent',
    include_granted_scopes: true,
    callback: (resp) => {
      if (resp && resp.access_token) {
        accessToken = resp.access_token;
        document.getElementById('gmailFetch').disabled = false;
        alert("Gmail verbunden ‚úÖ");
      } else {
        alert("Login abgebrochen");
      }
    }
  });
  gisClient.requestAccessToken();
});

/* === Gmail Abrufen (nur Qtrado) + Parser (Betreff/Body) === */
document.getElementById('gmailFetch').addEventListener('click', async ()=>{
  try{
    if(!accessToken){alert("‚ùå Kein Token ‚Äì bitte zuerst 'Gmail verbinden' klicken.");return;}
    // Nur Mails der letzten 90 Tage von Qtrado
    const query = '(from:qtrado OR from:@qtrado.de) newer_than:90d';
    alert("üîé Suche in Gmail nach:\n" + query);

    // Liste holen
    const res = await fetch(
      `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=25`,
      { headers:{Authorization:`Bearer ${accessToken}`} }
    );
    const list = await res.json();
    if(!res.ok){ alert("‚ùå Gmail-Fehler ("+res.status+"): "+JSON.stringify(list)); return; }
    if(!list.messages?.length){ alert("‚ÑπÔ∏è Keine Qtrado-Mails in den letzten 90 Tagen gefunden."); return; }

    let imported=0;

    for(const m of list.messages){
      const msg = await fetch(
        `https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}?format=full`,
        { headers:{Authorization:`Bearer ${accessToken}`} }
      ).then(r=>r.json());
      if(!msg.payload){ continue; }

      // Doppelte Sicherheit: From-Header pr√ºfen
      const headers = msg.payload.headers||[];
      const from = (headers.find(h=>h.name==='From')?.value || '').toLowerCase();
      if(!(from.includes('qtrado') || from.includes('@qtrado.de'))) { continue; }

      const subject = (headers.find(h=>h.name==='Subject')?.value)||'';
      let bodyText='';
      const parts = msg.payload.parts||[];
      const plain = parts.find(p=>p.mimeType==='text/plain')||msg.payload;
      if(plain?.body?.data) bodyText=atob(plain.body.data.replace(/-/g,'+').replace(/_/g,'/'));

      const ok = await mergeParsedIntoStore( scanTextForFields(subject+'\n'+bodyText) );
      if(ok) imported++;
    }

    alert(`‚úÖ Qtrado-E-Mails verarbeitet: ${imported}`);
  }catch(e){
    alert("‚ùå Fehler: "+(e.message||e));
  }
});
  </script>
</body>
</html>
