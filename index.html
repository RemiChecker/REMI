<!DOCTYPE html>
<!-- Presse Remi – Abgleich | Version 26.1.0 | Made by Durdu 2025 -->
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presse Remi – Abgleich v26.1.0</title>
</head>
<body>
  <h1>Presse Remi – Abgleich <span style="font-size:.8em;color:#666">v26.1.0</span></h1>
  <div id="overviewPackages"></div>
  <div id="overviewInvoices"></div>
  <footer>Made by Durdu 2025 – Version 26.1.0</footer>

<script>
const APP_VERSION = "26.1.0";

/* ===== Utils ===== */
const toast = m => { alert(m); };

/* PDF öffnen – Safari iOS Fix */
async function openPdfSmart(urlOrBlob) {
  try {
    let blob;
    if (urlOrBlob instanceof Blob) {
      blob = urlOrBlob;
    } else {
      const res = await fetch(urlOrBlob);
      blob = await res.blob();
    }
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      const reader = new FileReader();
      reader.onload = () => {
        const w = window.open('', '_blank', 'noopener');
        if (w) w.location.href = reader.result;
      };
      reader.readAsDataURL(blob);
    } else {
      const freshUrl = URL.createObjectURL(blob);
      window.open(freshUrl, '_blank', 'noopener');
    }
  } catch (e) {
    console.error(e);
    toast('PDF konnte nicht geöffnet werden.');
  }
}

/* ===== Dummy Speicher (ersetzt hier deine DB) ===== */
let store = {
  pakete: [
    { nr:"701", datum:"2025-09-12", rechnungen:["25390501358"], files:[{url:"example.pdf"}], status:"ok", differenzen:[] }
  ],
  rechnungen: {
    "25390501358": { nr:"25390501358", datum:"2025-09-28", items:[], files:[] }
  }
};

/* ===== Auto-Reparatur: Rechnungen PDFs von Paketen übernehmen ===== */
async function repairInvoiceFilesFromPackages(data) {
  let changed=false;
  for(const [rg,r] of Object.entries(data.rechnungen||{})) {
    if(r.files && r.files.length) continue;
    const donors=(data.pakete||[]).filter(p=>(p.rechnungen||[]).includes(rg) && p.files && p.files.length);
    if(!donors.length) continue;
    r.files ||= [];
    for(const p of donors) {
      for(const f of p.files) {
        if(!r.files.some(x=>x.url===f.url)) {
          r.files.push(f);
          changed=true;
        }
      }
    }
  }
  return changed;
}

/* ===== Render ===== */
async function render(data){
  const fixed = await repairInvoiceFilesFromPackages(data);
  if (fixed) toast("Rechnungs-PDFs repariert ✅");

  document.getElementById("overviewPackages").innerHTML =
    (data.pakete||[]).map(p=>`
      <details>
        <summary>
          Paket ${p.nr} (${p.datum}) 
          <a href="${p.files[0]?.url||'#'}" class="pkg-link" data-paket="${p.nr}">PDF</a>
        </summary>
      </details>`).join("");

  document.getElementById("overviewInvoices").innerHTML =
    Object.values(data.rechnungen||{}).map(r=>`
      <details>
        <summary>
          RG ${r.nr} (${r.datum})
          ${r.files?.length ? `<a href="${r.files[0].url}" class="rg-link" data-rg="${r.nr}">PDF</a>` : '<span>keine PDF</span>'}
        </summary>
      </details>`).join("");
}

/* ===== Link Handler ===== */
document.addEventListener('click', function(e) {
  const a = e.target.closest('a.rg-link, a.pkg-link');
  if (!a) return;
  e.preventDefault();
  e.stopPropagation();
  const href = a.getAttribute('href');
  if (href && href !== '#') openPdfSmart(href);
}, true);

/* ===== Init ===== */
render(store);
</script>
</body>
</html>
